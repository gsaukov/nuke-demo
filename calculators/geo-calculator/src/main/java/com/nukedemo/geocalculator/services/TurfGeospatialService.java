package com.nukedemo.geocalculator.services;


import com.mapbox.geojson.*;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

import javax.script.ScriptException;
import java.io.IOException;
import java.math.BigDecimal;
import java.util.List;
import java.util.stream.Collectors;

@Slf4j
@Service
public class TurfGeospatialService {

    private static final String TURF_LIBRARY = "classpath:scripts/turf.js";

    private GraalVMJSScriptingEngineService engine;

    public TurfGeospatialService(GraalVMJSScriptingEngineService graalJSScriptingEngine) throws ScriptException, IOException {
        this.engine = graalJSScriptingEngine;
        this.engine.registerPathResource(TURF_LIBRARY);
        log.info("Creating for thread: "+ Thread.currentThread().getId());
    }

    public BigDecimal calculateArea(String source) throws Exception {
        engine.getScriptEngine().put("data", source);
        String res = engine.getScriptEngine().eval("JSON.stringify(turf.area(turf.polygon(JSON.parse(data))))").toString();
        log.info(res);
        return new BigDecimal(res);
    }

    public Geometry union(List<Feature> features) throws Exception {
        List<CoordinateContainer> polygons = getCoordinatesContainer(features);
        if(polygons.isEmpty()){
            return null;
        }
        if(polygons.size()<2){
            return polygons.get(0);
        }
        String cumulative = polygons.get(0).toJson();
        for(int i = 1; i < features.size(); i++) {
            engine.getScriptEngine().put("cumulative", cumulative);
            engine.getScriptEngine().put("pol", polygons.get(i).toJson());
            String code = """
                        JSON.stringify(
                            turf.union(
                                turf.polygon(JSON.parse(cumulative)).geometry.coordinates,
                                turf.polygon(JSON.parse(pol)).geometry.coordinates
                            )
                        )
                    """;
            cumulative = engine.getScriptEngine().eval(code).toString();

        }

        return Feature.fromJson(cumulative).geometry();
    }

    public String clustersDbScan() throws Exception {
        String res = engine.getScriptEngine().eval("JSON.stringify(turf.clustersDbscan(turf.randomPoint(100, {bbox: [0, 30, 20, 50]}), 100))").toString();
        log.info(res);
        return res;
    }

    private List<CoordinateContainer> getCoordinatesContainer (List<Feature> features) {
        return features.stream().map(f -> f.geometry())
                .filter(g -> Polygon.class.isAssignableFrom(g.getClass())||MultiPolygon.class.isAssignableFrom(g.getClass()))
                .map(g -> (CoordinateContainer)g)
                .collect(Collectors.toList());
    }

}


/*
*
String cumulative = "[[[-77.0566909,38.8801488],[-77.0569427,38.8797772],[-77.0569004,38.8795442],[-77.0567948,38.8789615],[-77.0567102,38.8787298],[-77.0568265,38.8785927],[-77.0568177,38.878287],[-77.0567807,38.8781033],[-77.0568511,38.8775947],[-77.0569163,38.8770558],[-77.0570466,38.8763182],[-77.0571681,38.8758274],[-77.0573284,38.8752941],[-77.0575415,38.8747251],[-77.0578391,38.8739971],[-77.0578585,38.8738929],[-77.0580152,38.8737585],[-77.0581244,38.8735213],[-77.0583023,38.8731991],[-77.0584977,38.8728659],[-77.0586562,38.8725739],[-77.0589345,38.8720789],[-77.0593448,38.8714742],[-77.0595984,38.8710903],[-77.0598714,38.8705967],[-77.0601021,38.8701703],[-77.0604737,38.8695423],[-77.0604455,38.8694491],[-77.0598397,38.8690898],[-77.0599577,38.8689088],[-77.060051,38.8687457],[-77.0602395,38.8684509],[-77.0602518,38.8683096],[-77.0600951,38.8680327],[-77.0591987,38.8676172],[-77.0579588,38.8672483],[-77.0570096,38.8669741],[-77.0563369,38.8668164],[-77.0559434,38.8667524],[-77.0554651,38.8666848],[-77.0545863,38.8666327],[-77.0535103,38.8666217],[-77.0527654,38.8666519],[-77.0523092,38.8667026],[-77.0518742,38.866789],[-77.05164,38.8668479],[-77.0511575,38.8670043],[-77.0508352,38.8671318],[-77.050254,38.8674376],[-77.0500832,38.8675815],[-77.0498173,38.867683],[-77.0495989,38.8677845],[-77.0492942,38.8679655],[-77.0491146,38.868104],[-77.0485545,38.8684618],[-77.0482164,38.8687306],[-77.0480086,38.8689061],[-77.0478924,38.8690391],[-77.0478536,38.869157],[-77.0478977,38.8692681],[-77.04847,38.8696767],[-77.0486303,38.8698604],[-77.048986,38.8702718],[-77.0493664,38.8705419],[-77.0495076,38.8706178],[-77.0495522,38.8706255],[-77.0499951,38.8707846],[-77.0503421,38.871019],[-77.0507947,38.8713673],[-77.0514084,38.8714373],[-77.0514811,38.8717839],[-77.051575,38.8720371],[-77.0516754,38.8722422],[-77.0518151,38.8724574],[-77.0521854,38.8730618],[-77.0523956,38.8734016],[-77.0525946,38.8737262],[-77.0522969,38.874067],[-77.0523233,38.8743686],[-77.0523022,38.8746579],[-77.052318,38.8748087],[-77.0521296,38.8755422],[-77.0520961,38.8759741],[-77.0521965,38.8764128],[-77.0524078,38.8767213],[-77.0533499,38.8778261],[-77.0534802,38.8779554],[-77.053654,38.8780646],[-77.0538284,38.8781312],[-77.053972,38.8781658],[-77.0541128,38.8781787],[-77.0542007,38.8786215],[-77.0546251,38.8791068],[-77.0549285,38.879345],[-77.0550407,38.8794331],[-77.0557733,38.8799116],[-77.0560533,38.8800391],[-77.056402,38.880131],[-77.0566909,38.8801488]]]";
String pol = "[[[-77.0584431,38.8700424],[-77.0577193,38.8697366],[-77.0577247,38.8697293],[-77.0577169,38.8697245],[-77.0576384,38.869695],[-77.0564021,38.8691761],[-77.0563206,38.8691423],[-77.0563068,38.8691626],[-77.0560349,38.8690595],[-77.0560238,38.8690551],[-77.0559694,38.8690335],[-77.0559074,38.8690089],[-77.0558919,38.8690028],[-77.0555701,38.8688635],[-77.0550638,38.8692467],[-77.0550438,38.8692591],[-77.0548876,38.8693858],[-77.0548597,38.8693642],[-77.0547305,38.8694639],[-77.0543641,38.8697384],[-77.0540415,38.86998],[-77.0539136,38.8700834],[-77.0539357,38.8701019],[-77.0534971,38.8704359],[-77.0532601,38.8706206],[-77.0532453,38.8706325],[-77.0535805,38.871193],[-77.0535883,38.8712071],[-77.053568,38.8712162],[-77.0535805,38.8712364],[-77.0535405,38.8712532],[-77.0535998,38.8713498],[-77.0536401,38.8713334],[-77.0538107,38.8715871],[-77.0537309,38.8716151],[-77.0538616,38.8718226],[-77.0539766,38.8719987],[-77.0539816,38.8719963],[-77.0540495,38.871968],[-77.0542665,38.8723191],[-77.0542786,38.8723376],[-77.054303,38.8723291],[-77.0545859,38.8727849],[-77.0546652,38.8729108],[-77.0554817,38.8728275],[-77.0554857,38.872848],[-77.0555145,38.8728446],[-77.0555939,38.8728352],[-77.0560238,38.8727843],[-77.0560343,38.8728383],[-77.0560366,38.8728499],[-77.0561384,38.8728378],[-77.0562807,38.8728209],[-77.056446,38.8728015],[-77.0565594,38.8727882],[-77.0565573,38.8727774],[-77.0565463,38.872721],[-77.0569789,38.8726701],[-77.0570488,38.8726619],[-77.0570582,38.8726608],[-77.0570546,38.8726418],[-77.0578852,38.8725515],[-77.0579095,38.8724322],[-77.0580288,38.8719122],[-77.0580511,38.8719142],[-77.0582129,38.8711832],[-77.0583278,38.8706884],[-77.058295,38.8706841],[-77.0584431,38.8700424]],[[-77.0544016,38.8709022],[-77.0542805,38.8709457],[-77.0541734,38.8707789],[-77.0542659,38.8707147],[-77.0543058,38.8707408],[-77.0544016,38.8709022]],[[-77.0543783,38.8721016],[-77.053861,38.8712708],[-77.0539472,38.8712383],[-77.0544812,38.8720931],[-77.0544019,38.8721236],[-77.0543858,38.8720988],[-77.0543783,38.8721016]],[[-77.0547282,38.8719946],[-77.0546469,38.8720248],[-77.0541121,38.8711783],[-77.0541998,38.8711438],[-77.0547282,38.8719946]],[[-77.0581066,38.8700788],[-77.0580626,38.8701405],[-77.0576267,38.8699636],[-77.0576711,38.8698978],[-77.0581066,38.8700788]],[[-77.05759,38.8717017],[-77.0574955,38.8716889],[-77.0575906,38.8712645],[-77.0576853,38.8712774],[-77.05759,38.8717017]],[[-77.0575202,38.8707263],[-77.0573018,38.8716618],[-77.057173,38.871644],[-77.05739,38.8707093],[-77.0575202,38.8707263]],[[-77.0577797,38.8708456],[-77.0577106,38.8711622],[-77.0576153,38.8711481],[-77.0576867,38.8708314],[-77.0577797,38.8708456]],[[-77.0575865,38.8703621],[-77.0576001,38.8703856],[-77.057559,38.8705839],[-77.0574264,38.8705663],[-77.0574483,38.8704578],[-77.0574138,38.8704023],[-77.0572943,38.8703537],[-77.0573534,38.8702651],[-77.0575865,38.8703621]],[[-77.0578438,38.870569],[-77.0577353,38.8705545],[-77.0577951,38.8702837],[-77.0574888,38.8701571],[-77.0575334,38.8700917],[-77.0578886,38.8702385],[-77.0579108,38.8702658],[-77.0578438,38.870569]],[[-77.0549311,38.8702704],[-77.0546849,38.8704558],[-77.0546462,38.8704247],[-77.0548924,38.8702393],[-77.0549311,38.8702704]],[[-77.055308,38.8699855],[-77.0550593,38.8701728],[-77.0550206,38.8701416],[-77.0552693,38.8699543],[-77.055308,38.8699855]],[[-77.0567219,38.8697604],[-77.0566775,38.8698255],[-77.0561975,38.869627],[-77.0562419,38.8695619],[-77.0567219,38.8697604]],[[-77.0572594,38.8699807],[-77.0572133,38.8700453],[-77.0568168,38.8698829],[-77.0568613,38.8698168],[-77.0572594,38.8699807]],[[-77.0564095,38.8702458],[-77.0560137,38.8700824],[-77.0560625,38.870011],[-77.0564548,38.8701779],[-77.0564095,38.8702458]],[[-77.0565336,38.8703004],[-77.0565831,38.8702292],[-77.0569787,38.8703923],[-77.0569318,38.8704617],[-77.0565336,38.8703004]],[[-77.0543135,38.8704043],[-77.054086,38.8705728],[-77.0541083,38.8705898],[-77.0539758,38.8706882],[-77.0539578,38.8707669],[-77.0541084,38.8710047],[-77.0540259,38.8710337],[-77.053827,38.8707225],[-77.0538335,38.8706928],[-77.0542672,38.8703658],[-77.0543135,38.8704043]],[[-77.0547081,38.8709367],[-77.0552672,38.8717884],[-77.0551822,38.8718206],[-77.0546274,38.8709675],[-77.0547081,38.8709367]],[[-77.0567261,38.8718325],[-77.0556316,38.8719605],[-77.0556178,38.8718839],[-77.0567128,38.8717636],[-77.0567261,38.8718325]],[[-77.0568535,38.8725099],[-77.0556462,38.8726457],[-77.0556322,38.872568],[-77.0568401,38.8724417],[-77.0568535,38.8725099]],[[-77.0568251,38.872297],[-77.0556074,38.8724276],[-77.0555929,38.8723515],[-77.0568092,38.8722179],[-77.0568251,38.872297]],[[-77.0567573,38.8719777],[-77.0567781,38.8720831],[-77.0555678,38.8722082],[-77.0555485,38.8721074],[-77.0567573,38.8719777]],[[-77.0548256,38.8726404],[-77.0548624,38.8726566],[-77.0554442,38.8725917],[-77.055458,38.8726666],[-77.0548073,38.8727372],[-77.0547753,38.8727207],[-77.0544796,38.872257],[-77.0545651,38.8722226],[-77.0548256,38.8726404]],[[-77.0549917,38.8724],[-77.0550417,38.87242],[-77.0554074,38.8723744],[-77.05542,38.8724528],[-77.0549718,38.8725138],[-77.0549369,38.8724983],[-77.0547303,38.8721592],[-77.0548184,38.8721267],[-77.0549917,38.8724]],[[-77.05511,38.8721937],[-77.0551703,38.8722161],[-77.0552975,38.8722005],[-77.0552874,38.8721348],[-77.0553609,38.8721262],[-77.0553808,38.8722306],[-77.0551251,38.8722597],[-77.0550948,38.8722468],[-77.0549893,38.8720765],[-77.0550748,38.8720458],[-77.0550947,38.8720857],[-77.0550537,38.8720993],[-77.05511,38.8721937]],[[-77.0571964,38.8720271],[-77.0569645,38.8720527],[-77.0569469,38.8719539],[-77.0570719,38.8719447],[-77.0571338,38.8719076],[-77.0571556,38.8718024],[-77.0572602,38.8718156],[-77.0572195,38.8720116],[-77.0571964,38.8720271]],[[-77.0574485,38.8722241],[-77.0570037,38.8722713],[-77.0569903,38.8721959],[-77.057364,38.8721538],[-77.0573945,38.8721293],[-77.0574561,38.8718402],[-77.0575544,38.8718526],[-77.0574793,38.8722019],[-77.0574485,38.8722241]],[[-77.0578148,38.8719643],[-77.0577178,38.8723987],[-77.0576896,38.8724183],[-77.0571064,38.8724825],[-77.0570935,38.8724035],[-77.0576079,38.8723491],[-77.0576343,38.8723303],[-77.057711,38.8719545],[-77.0578148,38.8719643]],[[-77.0570103,38.8711973],[-77.0570904,38.8712077],[-77.0570189,38.8715415],[-77.0569388,38.8715311],[-77.0570103,38.8711973]],[[-77.057198,38.8707337],[-77.0571208,38.8710835],[-77.0570271,38.871071],[-77.0571043,38.8707212],[-77.057198,38.8707337]],[[-77.0578645,38.871302],[-77.0579562,38.8713147],[-77.0578604,38.8717397],[-77.0577688,38.8717274],[-77.0578645,38.871302]],[[-77.058054,38.8708819],[-77.0579834,38.8712011],[-77.0578915,38.8711884],[-77.0579631,38.8708681],[-77.058054,38.8708819]],[[-77.0582029,38.8702091],[-77.0581067,38.8706458],[-77.0580154,38.8706331],[-77.0581098,38.8701977],[-77.0582029,38.8702091]],[[-77.0559474,38.8696861],[-77.0558888,38.869773],[-77.0556839,38.8696942],[-77.0556515,38.8696578],[-77.0557334,38.8695962],[-77.0559474,38.8696861]],[[-77.0571981,38.8702031],[-77.0571379,38.8702897],[-77.0560539,38.8698422],[-77.0561108,38.8697565],[-77.0571981,38.8702031]],[[-77.0561469,38.8692695],[-77.0561019,38.869334],[-77.0556492,38.8691465],[-77.0556031,38.869151],[-77.0551318,38.8695088],[-77.0550665,38.8694547],[-77.0555906,38.8690562],[-77.055617,38.8690512],[-77.0561469,38.8692695]],[[-77.0560774,38.8694922],[-77.0560349,38.8695575],[-77.0557358,38.8694261],[-77.0556226,38.8694345],[-77.0555029,38.8695263],[-77.0554816,38.8695116],[-77.0552483,38.8696923],[-77.0552066,38.8696587],[-77.0556399,38.8693243],[-77.0556728,38.8693201],[-77.0560774,38.8694922]],[[-77.055115,38.8698285],[-77.0544817,38.8703055],[-77.0544214,38.870257],[-77.0550547,38.86978],[-77.055115,38.8698285]],[[-77.0549218,38.8696699],[-77.0542945,38.8701416],[-77.054228,38.870088],[-77.0548552,38.8696162],[-77.0549218,38.8696699]],[[-77.0538662,38.8711054],[-77.053777,38.8711375],[-77.0534844,38.8706766],[-77.0534898,38.8706471],[-77.0540161,38.8702446],[-77.0540888,38.8703034],[-77.0536046,38.8706625],[-77.0535983,38.8706914],[-77.0538662,38.8711054]],[[-77.056861,38.8695629],[-77.0568157,38.8696296],[-77.0563313,38.8694303],[-77.0563767,38.8693635],[-77.056861,38.8695629]],[[-77.0573907,38.8697829],[-77.0573462,38.8698486],[-77.0569511,38.8696857],[-77.0569956,38.8696192],[-77.0573907,38.8697829]],[[-77.0566474,38.8715412],[-77.0566061,38.8715741],[-77.056609,38.8716109],[-77.0561887,38.8716596],[-77.0561711,38.8716081],[-77.0560938,38.8716179],[-77.0560077,38.871631],[-77.0560166,38.8716795],[-77.055596,38.8717276],[-77.0555864,38.87168],[-77.0555239,38.8716609],[-77.0554698,38.8716362],[-77.0554156,38.8716569],[-77.0552359,38.8713651],[-77.0552796,38.8713478],[-77.0552459,38.8712964],[-77.0551992,38.8712251],[-77.0551587,38.8712411],[-77.0549644,38.8709291],[-77.0550047,38.8709161],[-77.0550127,38.8708702],[-77.0550202,38.8708312],[-77.0549883,38.8708058],[-77.0557351,38.8702234],[-77.0557737,38.8702538],[-77.0558172,38.8702498],[-77.0558775,38.870242],[-77.0558979,38.8702081],[-77.0568134,38.8705878],[-77.0567988,38.870634],[-77.0568234,38.8706734],[-77.056848,38.8707126],[-77.056892,38.8707178],[-77.0567301,38.8715101],[-77.0566963,38.8715074],[-77.0566474,38.8715412]]]";

engine.getScriptEngine().put("cumulative", cumulative);
engine.getScriptEngine().put("pol", pol);
cumulative = engine.getScriptEngine().eval("JSON.stringify(turf.union(turf.polygon(JSON.parse(cumulative)), turf.polygon(JSON.parse(pol))))").toString();
*/
